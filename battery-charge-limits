#! /bin/sh
#
# Laptop mode tools module: battery-charge-limits
#

if [ x$CONTROL_BATTERY_CHARGE_LIMITS = x1 ] ; then
	ENABLE_BATTERY_CHARGE_LIMITS=$BATT_BATTERY_CHARGE_LIMITS
	CHARGE_CONTROL_START_THRESHOLD=$BATT_CHARGE_CONTROL_START_THRESHOLD
	CHARGE_CONTROL_END_THRESHOLD=$BATT_CHARGE_CONTROL_END_THRESHOLD

	if [ $ON_AC -eq 1 ] ; then
		if [ "$ACTIVATE" -eq 1 ]; then
		    ENABLE_BATTERY_CHARGE_LIMITS=$LM_AC_BATTERY_CHARGE_LIMITS
		    CHARGE_CONTROL_START_THRESHOLD=$LM_AC_CHARGE_CONTROL_START_THRESHOLD
		    CHARGE_CONTROL_END_THRESHOLD=$LM_AC_CHARGE_CONTROL_END_THRESHOLD
		else
		    ENABLE_BATTERY_CHARGE_LIMITS=$NOLM_AC_BATTERY_CHARGE_LIMITS
		    CHARGE_CONTROL_START_THRESHOLD=$NOLM_AC_CHARGE_CONTROL_START_THRESHOLD
		    CHARGE_CONTROL_END_THRESHOLD=$NOLM_AC_CHARGE_CONTROL_END_THRESHOLD
		fi
	fi

	if [ x$ENABLE_BATTERY_CHARGE_LIMITS = x1 ] ; then
		log "VERBOSE" "Enabling charge control (start $CHARGE_CONTROL_START_THRESHOLD; end $CHARGE_CONTROL_END_THRESHOLD)"
	else
		# Defaults
		CHARGE_CONTROL_START_THRESHOLD=0
		CHARGE_CONTROL_END_THRESHOLD=100

		log "VERBOSE" "Disabling charge control (start $CHARGE_CONTROL_START_THRESHOLD; end $CHARGE_CONTROL_END_THRESHOLD)"
	fi

	for i in /sys/class/power_supply/BAT[0-9]*/charge_control_start_threshold; do
		echo $CHARGE_CONTROL_START_THRESHOLD > $i
	done

	for i in /sys/class/power_supply/BAT[0-9]*/charge_control_end_threshold; do
		echo $CHARGE_CONTROL_END_THRESHOLD > $i
	done
fi
